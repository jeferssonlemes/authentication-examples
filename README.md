# üõ°Ô∏è JWT Authentication & Security Examples

Este projeto demonstra a implementa√ß√£o abrangente de m√∫ltiplas camadas de seguran√ßa em uma aplica√ß√£o ASP.NET Core, incluindo autentica√ß√£o JWT, prote√ß√£o CSRF, headers de seguran√ßa, preven√ß√£o XSS e muito mais.

## üìã √çndice

- [Vis√£o Geral da Arquitetura de Seguran√ßa](#-vis√£o-geral-da-arquitetura-de-seguran√ßa)
- [Camadas de Seguran√ßa Implementadas](#-camadas-de-seguran√ßa-implementadas)
- [Fluxo de Autentica√ß√£o](#-fluxo-de-autentica√ß√£o)
- [Prote√ß√µes Implementadas](#-prote√ß√µes-implementadas)
- [Como Executar](#-como-executar)
- [Testes de Seguran√ßa](#-testes-de-seguran√ßa)
- [Estrutura do Projeto](#-estrutura-do-projeto)

## üèóÔ∏è Vis√£o Geral da Arquitetura de Seguran√ßa

Este projeto implementa um sistema de seguran√ßa em m√∫ltiplas camadas, cada uma com responsabilidades espec√≠ficas:

### üîí Camadas de Seguran√ßa por N√≠vel

```mermaid
graph TB
    Client[Cliente/Browser]
    
    subgraph "Frontend Security Layer"
        XSS[XSS Protection JS]
        CSRF_CLIENT[CSRF Helper]
        INPUT_SANITIZATION[Input Sanitization]
    end
    
    subgraph "Transport Security Layer"
        HTTPS[HTTPS/TLS]
        CORS[CORS Policy]
        HEADERS[Security Headers]
    end
    
    subgraph "Application Security Layer"
        JWT[JWT Authentication]
        ANTIFORGERY[Anti-Forgery Tokens]
        AUTHORIZATION[Authorization Policies]
    end
    
    subgraph "Middleware Security Layer"
        EXCEPTION[Exception Handling]
        STATUS_CODES[Status Code Pages]
        HEADER_MIDDLEWARE[Security Headers Middleware]
    end
    
    subgraph "Backend Security Layer"
        INPUT_VALIDATION[Server Input Validation]
        XSS_DETECTION[XSS Detection]
        LOGGING[Security Logging]
    end
    
    Client --> Frontend
    Frontend --> Transport
    Transport --> Application
    Application --> Middleware
    Middleware --> Backend
```

## üõ°Ô∏è Camadas de Seguran√ßa Implementadas

### 1. **Autentica√ß√£o JWT (JSON Web Tokens)**

#### üìç Localiza√ß√£o

- `Extensions/AuthenticationExtensions.cs`
- `Services/AuthService.cs`
- `Controllers/AuthController.cs`

#### üîß Implementa√ß√£o

```csharp
// Configura√ß√£o JWT
builder.Services.AddJwtAuthentication(builder.Configuration);

// Gera√ß√£o de token
var token = _jwtService.GenerateToken(user.Username, user.Role);
```

#### ‚úÖ Benef√≠cios

- **Stateless**: N√£o requer armazenamento de sess√£o no servidor
- **Escal√°vel**: Funciona bem em ambientes distribu√≠dos
- **Seguro**: Tokens assinados digitalmente
- **Flex√≠vel**: Suporte a diferentes roles e claims

---

### 2. **Prote√ß√£o CSRF (Cross-Site Request Forgery)**

#### üìç Localiza√ß√£o

- `Program.cs` (configura√ß√£o)
- `Controllers/AntiForgeryController.cs`
- `wwwroot/js/csrf-helper.js`

#### üîß Implementa√ß√£o

```csharp
// Configura√ß√£o Anti-Forgery
builder.Services.AddAntiforgery(options =>
{
    options.HeaderName = "X-CSRF-TOKEN";
    options.Cookie.HttpOnly = true;
    options.Cookie.SecurePolicy = CookieSecurePolicy.SameAsRequest;
    options.Cookie.SameSite = SameSiteMode.Strict;
});
```

#### ‚úÖ Benef√≠cios

- **Preven√ß√£o de CSRF**: Impede ataques de requisi√ß√µes forjadas
- **Token por requisi√ß√£o**: Cada requisi√ß√£o tem seu pr√≥prio token
- **Cookie seguro**: Configura√ß√µes rigorosas de seguran√ßa
- **API friendly**: Suporte tanto para forms quanto para APIs

---

### 3. **Headers de Seguran√ßa**

#### üìç Localiza√ß√£o

- `Program.cs` (middleware personalizado)

#### üîß Implementa√ß√£o

```csharp
app.Use(async (context, next) =>
{
    // Verifica√ß√£o de duplica√ß√£o para evitar erro em re-execu√ß√£o
    if (!context.Response.Headers.ContainsKey("X-Content-Type-Options"))
        context.Response.Headers.Add("X-Content-Type-Options", "nosniff");
    
    if (!context.Response.Headers.ContainsKey("X-Frame-Options"))
        context.Response.Headers.Add("X-Frame-Options", "DENY");
    
    if (!context.Response.Headers.ContainsKey("X-XSS-Protection"))
        context.Response.Headers.Add("X-XSS-Protection", "1; mode=block");
    
    if (!context.Response.Headers.ContainsKey("Content-Security-Policy"))
        context.Response.Headers.Add("Content-Security-Policy", 
            "default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net...");
    
    await next();
});
```

#### ‚úÖ Headers Implementados

- **X-Content-Type-Options**: Previne MIME type sniffing
- **X-Frame-Options**: Previne clickjacking  
- **X-XSS-Protection**: Ativa prote√ß√£o XSS do browser
- **Content-Security-Policy**: Pol√≠tica rigorosa de conte√∫do
- **Referrer-Policy**: Controla informa√ß√µes de referrer

---

### 4. **Prote√ß√£o XSS (Cross-Site Scripting)**

#### üìç Localiza√ß√£o

- `wwwroot/js/xss-protection.js`
- `Controllers/SecurityController.cs`

#### üîß Implementa√ß√£o Frontend

```javascript
class XSSProtection {
    escapeHtml(unsafe) {
        return unsafe
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }
    
    sanitizeText(text) {
        const dangerous = /<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi;
        return this.escapeHtml(text.replace(dangerous, ""));
    }
}
```

#### üîß Implementa√ß√£o Backend

```csharp
private bool DetectXSSAttempt(string input)
{
    var suspiciousPatterns = new[]
    {
        "<script", "javascript:", "onload=", "onclick=", 
        "eval(", "alert(", "document.cookie"
    };
    
    return suspiciousPatterns.Any(pattern =>
        input.Contains(pattern, StringComparison.OrdinalIgnoreCase));
}
```

#### ‚úÖ Benef√≠cios

- **Detec√ß√£o proativa**: Identifica tentativas de XSS
- **Sanitiza√ß√£o autom√°tica**: Limpa inputs perigosos
- **Logging**: Registra tentativas de ataque
- **Dupla prote√ß√£o**: Frontend + Backend

---

### 5. **Autoriza√ß√£o Baseada em Pol√≠ticas**

#### üìç Localiza√ß√£o

- `Extensions/AuthorizationExtensions.cs`
- `Requirements/` (custom requirements)
- `Handlers/` (authorization handlers)

#### üîß Implementa√ß√£o

```csharp
builder.Services.AddPermissionPolicies();

// Pol√≠ticas customizadas
services.AddAuthorization(options =>
{
    options.AddPolicy("AdminOnly", policy =>
        policy.RequireRole("Admin"));
        
    options.AddPolicy("UserOrAdmin", policy =>
        policy.RequireRole("User", "Admin"));
});
```

#### ‚úÖ Benef√≠cios

- **Granularidade**: Controle fino de acesso
- **Flexibilidade**: Pol√≠ticas customiz√°veis
- **Reutiliza√ß√£o**: Pol√≠ticas aplic√°veis em m√∫ltiplos endpoints
- **Manutenibilidade**: L√≥gica centralizada

---

### 6. **Middleware de Tratamento de Exce√ß√µes**

#### üìç Localiza√ß√£o

- `Middlewares/ExceptionHandlingMiddleware.cs`

#### üîß Implementa√ß√£o

```csharp
public async Task InvokeAsync(HttpContext context)
{
    try
    {
        await _next(context);
    }
    catch (Exception ex)
    {
        _logger.LogError(ex, "Erro n√£o tratado ocorreu.");
        await HandleExceptionAsync(context, ex);
    }
}
```

#### ‚úÖ Benef√≠cios

- **Tratamento centralizado**: Um local para todas as exce√ß√µes
- **Logging**: Registro detalhado de erros
- **Resposta adequada**: JSON para APIs, redirecionamento para web
- **Seguran√ßa**: N√£o vaza informa√ß√µes sens√≠veis

---

### 7. **Configura√ß√£o CORS**

#### üìç Localiza√ß√£o

- `Program.cs`

#### üîß Implementa√ß√£o

```csharp
builder.Services.AddCors(options =>
{
    options.AddPolicy("AllowAll", policy =>
    {
        policy.AllowAnyOrigin()
              .AllowAnyMethod()
              .AllowAnyHeader()
              .WithExposedHeaders("X-CSRF-TOKEN");
    });
});
```

#### ‚úÖ Benef√≠cios

- **Controle de origem**: Define quais dom√≠nios podem acessar a API
- **Headers personalizados**: Exp√µe headers necess√°rios (CSRF)
- **Flexibilidade**: Diferentes pol√≠ticas para diferentes cen√°rios

## üîÑ Fluxo de Autentica√ß√£o

```mermaid
sequenceDiagram
    participant U as User
    participant C as Client
    participant MW as Middleware
    participant Auth as AuthController
    participant JWT as JWTService
    participant API as Protected API

    U->>C: 1. Login Request
    C->>Auth: 2. POST /api/auth/login
    Auth->>JWT: 3. Generate Token
    JWT-->>Auth: 4. JWT Token
    Auth-->>C: 5. Token + User Info
    C->>C: 6. Store JWT in localStorage
    
    Note over C: Subsequent API calls
    C->>MW: 7. API Request + Bearer Token
    MW->>MW: 8. Validate JWT
    alt Valid Token
        MW->>API: 9. Forward Request
        API-->>MW: 10. Response
        MW-->>C: 11. Response
    else Invalid Token
        MW-->>C: 12. 401 Unauthorized
    end
```

## üõ†Ô∏è Fluxo de Prote√ß√£o CSRF

```mermaid
sequenceDiagram
    participant C as Client
    participant CSRF as CSRF Controller
    participant MW as Middleware
    participant API as Protected API

    C->>CSRF: 1. GET /api/antiforgery/token
    CSRF-->>C: 2. CSRF Token + Cookie
    C->>C: 3. Store token
    
    Note over C: Protected operation
    C->>MW: 4. POST with X-CSRF-TOKEN header
    MW->>MW: 5. Validate CSRF token
    alt Valid CSRF
        MW->>API: 6. Forward request
        API-->>MW: 7. Response
        MW-->>C: 8. Success response
    else Invalid CSRF
        MW-->>C: 9. 400 Bad Request
    end
```

## üîç Pipeline de Seguran√ßa

```mermaid
flowchart TD
    START([Request Iniciada]) --> CORS{CORS Check}
    CORS -->|Allow| HEADERS[Add Security Headers]
    CORS -->|Block| BLOCK1[‚ùå CORS Blocked]
    
    HEADERS --> HTTPS{HTTPS?}
    HTTPS -->|No| REDIRECT[Redirect to HTTPS]
    HTTPS -->|Yes| AUTH{Needs Auth?}
    
    AUTH -->|No| CSRF{Needs CSRF?}
    AUTH -->|Yes| JWT{Valid JWT?}
    
    JWT -->|No| UNAUTH[‚ùå 401 Unauthorized]
    JWT -->|Yes| AUTHZ{Authorized?}
    
    AUTHZ -->|No| FORBID[‚ùå 403 Forbidden]
    AUTHZ -->|Yes| CSRF
    
    CSRF -->|No| PROCESS[Process Request]
    CSRF -->|Yes| CSRF_VALID{Valid CSRF?}
    
    CSRF_VALID -->|No| CSRF_FAIL[‚ùå CSRF Failed]
    CSRF_VALID -->|Yes| XSS[XSS Detection]
    
    XSS -->|Suspicious| LOG[Log & Block]
    XSS -->|Safe| PROCESS
    
    PROCESS --> SUCCESS[‚úÖ Success]
    
    style START fill:#e1f5fe
    style SUCCESS fill:#e8f5e8
    style BLOCK1 fill:#ffebee
    style UNAUTH fill:#ffebee
    style FORBID fill:#ffebee
    style CSRF_FAIL fill:#ffebee
    style LOG fill:#fff3e0
```

## üöÄ Como Executar

### Pr√©-requisitos

- .NET 8.0 SDK
- Visual Studio 2022 ou VS Code

### Passos

1. **Clone o reposit√≥rio**

   ```bash
   git clone <repo-url>
   cd authentication-examples
   ```

2. **Configure as settings**

   ```json
   // appsettings.json
   {
     "Jwt": {
       "Key": "sua-chave-super-secreta-de-pelo-menos-32-caracteres",
       "Issuer": "JwtAuthApp",
       "Audience": "JwtAuthApp",
       "ExpirationInHours": 1
     }
   }
   ```

3. **Execute a aplica√ß√£o**

   ```bash
   cd JwtAuthApp
   dotnet run
   ```

4. **Acesse**
   - Aplica√ß√£o: `https://localhost:5001`
   - Swagger: `https://localhost:5001/swagger`

## üß™ Testes de Seguran√ßa

### Testando Autentica√ß√£o JWT

```bash
# 1. Login
curl -X POST https://localhost:5001/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}'

# 2. Usar token
curl -X GET https://localhost:5001/api/auth/protected \
  -H "Authorization: Bearer <seu-token>"
```

### Testando Prote√ß√£o CSRF

```bash
# 1. Obter token CSRF
curl -X GET https://localhost:5001/api/antiforgery/token

# 2. Usar token CSRF
curl -X POST https://localhost:5001/api/antiforgery/validate \
  -H "X-CSRF-TOKEN: <csrf-token>" \
  -H "Content-Type: application/json" \
  -d '{"test":"data"}'
```

### Testando Prote√ß√£o XSS

- Acesse `/Home/Admin`
- Use o campo "Test XSS Protection"
- Tente inputs como: `<script>alert('xss')</script>`

## üìÅ Estrutura do Projeto

```
JwtAuthApp/
‚îú‚îÄ‚îÄ Controllers/
‚îÇ   ‚îú‚îÄ‚îÄ AuthController.cs          # Autentica√ß√£o JWT
‚îÇ   ‚îú‚îÄ‚îÄ SecurityController.cs      # Testes de seguran√ßa
‚îÇ   ‚îú‚îÄ‚îÄ AntiForgeryController.cs   # Prote√ß√£o CSRF
‚îÇ   ‚îî‚îÄ‚îÄ ErrorController.cs         # Tratamento de erros
‚îú‚îÄ‚îÄ Extensions/
‚îÇ   ‚îú‚îÄ‚îÄ AuthenticationExtensions.cs # Config JWT
‚îÇ   ‚îî‚îÄ‚îÄ AuthorizationExtensions.cs  # Pol√≠ticas
‚îú‚îÄ‚îÄ Middlewares/
‚îÇ   ‚îî‚îÄ‚îÄ ExceptionHandlingMiddleware.cs # Tratamento exce√ß√µes
‚îú‚îÄ‚îÄ Services/
‚îÇ   ‚îî‚îÄ‚îÄ AuthService.cs             # L√≥gica de autentica√ß√£o
‚îú‚îÄ‚îÄ wwwroot/js/
‚îÇ   ‚îú‚îÄ‚îÄ xss-protection.js          # Prote√ß√£o XSS frontend
‚îÇ   ‚îú‚îÄ‚îÄ csrf-helper.js             # Helper CSRF
‚îÇ   ‚îî‚îÄ‚îÄ admin-functions.js         # Fun√ß√µes de teste
‚îî‚îÄ‚îÄ Program.cs                     # Configura√ß√£o principal
```

## üìä Resumo das Prote√ß√µes

| Amea√ßa | Prote√ß√£o Implementada | Status |
|--------|----------------------|---------|
| **XSS** | Headers CSP + Sanitiza√ß√£o + Detec√ß√£o | ‚úÖ |
| **CSRF** | Anti-Forgery Tokens | ‚úÖ |
| **Clickjacking** | X-Frame-Options: DENY | ‚úÖ |
| **MIME Sniffing** | X-Content-Type-Options: nosniff | ‚úÖ |
| **Info Disclosure** | Middleware de exce√ß√µes | ‚úÖ |
| **Unauthorized Access** | JWT + Authorization Policies | ‚úÖ |
| **Input Injection** | Sanitiza√ß√£o + Valida√ß√£o | ‚úÖ |
| **Security Headers** | Middleware personalizado | ‚úÖ |

## üîê Considera√ß√µes de Seguran√ßa

### Em Produ√ß√£o

- [ ] Usar HTTPS sempre (`RequireHttps`)
- [ ] Configurar JWT keys mais robustas
- [ ] Implementar rate limiting
- [ ] Configurar logging detalhado
- [ ] Implementar monitoring de seguran√ßa
- [ ] Usar secrets management (Azure Key Vault, etc.)

### Monitoramento

- [ ] Alertas para tentativas de XSS
- [ ] Monitoramento de falhas de autentica√ß√£o
- [ ] An√°lise de padr√µes de ataques
- [ ] Dashboard de seguran√ßa

---

## üë• Contribui√ß√£o

Para contribuir com este projeto:

1. Fork o reposit√≥rio
2. Crie uma branch para sua feature
3. Implemente com testes de seguran√ßa
4. Documente as mudan√ßas
5. Submeta um Pull Request

## üìÑ Licen√ßa

Este projeto √© distribu√≠do sob a licen√ßa MIT. Consulte o arquivo `LICENSE` para mais detalhes.

---

**‚ö†Ô∏è Importante**: Este projeto √© para fins educacionais e demonstra√ß√£o de conceitos de seguran√ßa. Para uso em produ√ß√£o, realize auditoria de seguran√ßa completa e siga as melhores pr√°ticas espec√≠ficas do seu ambiente.
